#!/usr/bin/env node

const needle = require('needle');
const path = require('path');
const logdir = '/var/log/coinglue';
const errlog = path.resolve(logdir, `coinhook_${Date.now()}.err`);
const user = process.env.USER;
const config = require('../src/config');
const crypto = require('crypto');
const fs = require('fs-extra');
const hook = config.get('hook');

if (!hook) {
  fs.appendFileSync(errlog, `[${user}] [${new Date()}] Hook api not found`);
  process.exit(0);
}
if (process.argv.length < 5) {
  fs.appendFileSync(errlog, `[${user}] [${new Date()}] Got ${process.argv.length} arguments (not 5)`);
  process.exit(1);
}
const TRX = process.argv[2];
const COIN = process.argv[3];
const SECRET = process.argv[4];
const postData = JSON.stringify({ tx: TRX, coin: COIN });
const HMACSIG = crypto.createHmac('sha1', SECRET).update(postData).digest('hex');
const logfile = path.resolve(logdir, `coinhook_${COIN}.log`);
fs.ensureFileSync(logfile);

fs.appendFileSync(logfile, `[${user}] [${new Date()}] [LOG] ${TRX} ${COIN} ${HMACSIG}\n`);
const options = {
  headers: {
    'Content-Type': 'application/json',
    'Content-Length': Buffer.byteLength(postData),
    'X-Coinworks-Sig': HMACSIG,
    'User-Agent': 'Coinworks-WebHook'
  }
};
needle.post(hook.host, postData, options, (err, resp) => {
  if (err) {
    fs.appendFileSync(logfile, `[${user}] [${new Date()}] [ERROR] Problem with request: ${err.message}\n`);
  } else {
    fs.appendFileSync(logfile, `[${user}] [${new Date()}] [LOG] Successful request: ${JSON.stringify(resp.body)}`);
  }
});
